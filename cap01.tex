\section{Introduccion}
\label{ch:introduccion:primera}
La virtualización es un conjunto de técnicas hardware y/o software que permiten la ejecución
concurrente de instancias aisladas de distintos sistemas operativos en una misma plataforma
electrónica. A estos sistemas operativos se les denomina guest.
Los hipervisores fueron originalmente introducidos en el mundo IT para solucionar los problemas de
balanceo de carga y utilización de recursos en data centers. En sus inicios, los hipervisores necesitaban cambios en
los sistemas operativos guest para compensar la falta de soporte hardware para el aislamiento
entre sistemas. A medida que las arquitecturas de micorprocesadores han ido avanzando y añadiendo
soporte hardware para la virtualización, los hipervisores se han vuelto cada vez más habituales en los
sistemas embebidos.

La inclusión de soporte hardware para la virtualización dentro de las nuevos microprocesadores ha sido
el habilitador necesario para que la virtualización de el salto del mundo IT a los sistemas embebidos. Las
arquitecturas más importantes de microprocesadores han evolucionado hacia la inclusión de ése soporte hardware.
Como ejemplos notables están Intel VT-x, las extensiones de virtualización de la arquitectura ARM y MIPS VZ
extensions.
Este soporte hardware, lo que aporta es un modo de ejecución nuevo, con mayores privilegios que el tradicional modo
supervisor e IO MMUs para aislar periféricos entre sistemas operativos guest. La versión de intel de IO MMU recibe el
nombre de VT-d y en la mayoría de los sistemas ARM, existe un ``System MMU'' equivalente. En los data center, el IO MMU se denomina habitualmente ``Single Root Virtualization'' o SRV.\\[1cm]
\textbf{Casos de uso}
\begin{itemize}
	\item Sistemas de criticidad mixta\\
	El caso más habitual de uso de los hipervisores es el de consolidar diferentes cargas de computación en una única
	plataforma para reducir el tamaño, consumo y coste de un sistema. Los sistemas operativos guest, al estar aislados unos de otros, hace que parezca que están ejecutándose en máquinas físicamente distintas. En el mundo de la automoción por ejemplo,
	se dan casos en los que se combina el clúster de instrumentación o dashboard con el sistema de infotainment (IVI) en una sola unidad de control electrónica (ECU). El clúster de instrumentación está desarrollado normalmente sobre un sistema operativo de tiempo real (RTOS), mientras que el IVI habitualmente requiere de un sistema operativo Linux u otro sistema operativo de propósito general (GPOS). La criticidad mixta se refiere a que los requisitos de tiempo real y seguridad del clúster de instrumentación no pueden ser cubiertos por un GPOS y las librerías multimedia necesarias para el sistema de infotainment son costas de protar a un RTOS. Por lo tanto integrar estas funcionalidades a la vez en un único sistem operativo no es viable. Un hipervisor con características de tiempo real y seguridad es capaz de hacer que ambos sistemas se puedan ejecutar en un mismo procesador. Esto permite un ahorro de costes significativo al necesitarse una única tarjeta y PCB para todo el sistema.
	\item Sistemas Legacy\\
	A medida que los sistemas evolucionan con el tiempo, a menudo es necesario moverse a nuevos entornos o sitemas operativos para añadir funcionalidades. Preservar la funcionalidad ya existente y certificada del sistema requeriría portar todo el código a la nueva plataforma y probar todo de nuevo. La virtualización permite la ejcución concurrente de la funcionalidad tal cual fue certificada junto con el nuevo software que añade funcionalidades en el mismo procesador. Un ejemplo de esto es la radio definida por software. Los requisitos pueden ir cambiando con el tiempo y pasar de un simple interfaz LCD a un interfaz gráfico de usuario (GUI). La parte de radio puede ser my costosa de recertificar. Utilizando virtualización, se puede mantener la parte de radio tal cual fue certificada y añadir un sistema operativo con una librería moderna de GUI.
	Este caso de uso es el más comun en los sistemas muy sensibles al coste.\\[1cm]
\end{itemize}
\textbf{Capacidades de los hipervisores}
Todos los hipervisores proporcionan mecanismos de compartición de recursos en sistemas on chip (SoC), pero difieren en la profundidad y el soporte hardware.
\begin{itemize}
	\item Compartición de memoria\\
	El hipervisor más básico en un SoC solo proporciona la compartición de memoria. Cada sistema guest se le asigna una CPU. El hipervisor configura el sistema de memoria virtualizada del SoC para restringir a cada CPU a una parte del mapa de memoria, incluyendo memoria RAM y periféricos. Esto permite a distintos sistemas operativos guest ejecutarse en un único SoC con periféricos disjuntos y acceso seguro a RAM.
	\item Compartición de CPU\\
	Un hipervisor más sofisticado, permite la compartición de cores de CPU individuales utilizando multiplexado en el tiempo. Esto permite a las diferentes cargas computacionales disponer de todos los recursos de la CPU en situaciones de alta demanda y particionar ese acceso en función de la prioridad. Por ejemplo, en el caso de la coexistencia de un RTOS y un GPOS, el RTOS tiene normalmente mayor prioridad en las CPUs, mientras que al GPOS se le garantiza un tiempo mínimo de ejecución. El GPOS tiene acceso completo mientras que el RTOS está inactivo. Hay que tener en cuenta que los hipervisores que permiten la compartición de CPU deben de ser diseñados con compartamiento en tiempo real, y normalmente están basados en algún RTOS.
	\item Compartición de periféricos\\
	Otra de las características de los hipervisores es la compartición de periféricos tales como dispositivos de almacenamiento, interfaces de red o GPUs. Los sistemas embebidos suelen ser sensibles al coste y por tanto el poder compartir un dispositivo eMMC es casi un requisito. Hay diferentes técnicas para implementar la compartición de periféricos que se comentarán más adelante.
\end{itemize}

 La parte de software encargada de
monitorizar y gestionar las diferentes máquinas virtuales y el acceso que tienen a los recursos del
sistema es lo que se denomina hipervisor.
Existen diferentes tipos de virtualización y por tanto de hipervisores. Hay dos grandes grupos de
hipervisores:
\begin{itemize}
\item Tipo 1 o baremetal: en este grupo están los hipervisores que se ejecutan directamente sobre
la plataforma electrónica sin ningún otro software de por medio, tipo sistema operativo u
otros controladores. Tienen acceso directo al hardware.
\item Tipo 2: estos hipervisores suelen instalarse sobre un sistema operativo (host) de base y
acceden a los recursos del sistema (memoria, procesadores, almacenamiento, red, etc.) a
través de él.
\end{itemize}
